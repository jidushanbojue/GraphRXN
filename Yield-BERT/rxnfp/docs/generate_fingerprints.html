---

title: Fingerprint generation


keywords: fastai
sidebar: home_sidebar

summary: "Generate RXN fingerprints for the 50k Schneider et al. data set"
description: "Generate RXN fingerprints for the 50k Schneider et al. data set"
nb_path: "nbs/03_generate_fingerprints.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_generate_fingerprints.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">tqdm_notebook</span>
<span class="kn">from</span> <span class="nn">rxnfp.transformer_fingerprints</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RXNBERTFingerprintGenerator</span><span class="p">,</span> <span class="n">get_default_model_and_tokenizer</span><span class="p">,</span> <span class="n">generate_fingerprints</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-data">Load data<a class="anchor-link" href="#Load-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/schneider50k.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>original_rxn</th>
      <th>rxn_class</th>
      <th>source</th>
      <th>rxn</th>
      <th>split</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>[CH3:17][S:14](=[O:15])(=[O:16])[N:11]1[CH2:10...</td>
      <td>6.1.5</td>
      <td>US06887874</td>
      <td>C1CCCCC1.CCO.CS(=O)(=O)N1CCN(Cc2ccccc2)CC1.[OH...</td>
      <td>test</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>O.O.[Na+].[CH3:1][c:2]1[cH:7][c:6]([N+:8](=O)[...</td>
      <td>7.1.1</td>
      <td>US07056926</td>
      <td>CCOC(C)=O.Cc1cc([N+](=O)[O-])ccc1NC(=O)c1ccccc...</td>
      <td>test</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>[CH3:1][O:2][c:3]1[cH:4][cH:5][c:6](-[c:9]2[cH...</td>
      <td>1.8.5</td>
      <td>US08492378</td>
      <td>COc1ccc(-c2coc3ccc(-c4nnc(S)o4)cc23)cc1.COc1cc...</td>
      <td>test</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Cl.[CH3:43][CH2:42][S:44](=[O:45])(=[O:46])Cl....</td>
      <td>2.2.3</td>
      <td>US08592454</td>
      <td>CCS(=O)(=O)Cl.CN(C(=O)N(C)[C@@H]1CN(C(=O)C2CCN...</td>
      <td>train</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>[CH3:25][O:24][c:21]1[cH:22][cH:23][c:17]([O:1...</td>
      <td>1.3.7</td>
      <td>US06716851</td>
      <td>COc1ccc(OC)c(N)c1.Cc1cc(Cl)nc(-c2ccccn2)n1&gt;&gt;CO...</td>
      <td>test</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ft_10k-model">ft_10k model<a class="anchor-link" href="#ft_10k-model"> </a></h3><p>This model was fine tuned on 10k reactions from the Schneider data set.</p>
<p>Generate and save the fingerprints.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_default_model_and_tokenizer</span><span class="p">(</span><span class="s1">&#39;bert_ft_10k_25s&#39;</span><span class="p">)</span>
<span class="n">ft_10k_rxnfp_generator</span> <span class="o">=</span> <span class="n">RXNBERTFingerprintGenerator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>

<span class="n">fps_ft_10k</span> <span class="o">=</span> <span class="n">generate_fingerprints</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rxn</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ft_10k_rxnfp_generator</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="s1">&#39;../data/fps_ft_10k&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps_ft_10k</span><span class="p">)</span>
<span class="n">fps_ft_10k</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 6250/6250 [02:52&lt;00:00, 36.31it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(50000, 256)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How to load the fingerprints:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fps_ft_10k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;../data/fps_ft_10k.npz&#39;</span><span class="p">)[</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="pretrained-model">pretrained model<a class="anchor-link" href="#pretrained-model"> </a></h3><p>This model was only pretrained on reaction data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_default_model_and_tokenizer</span><span class="p">(</span><span class="s1">&#39;bert_pretrained&#39;</span><span class="p">)</span>
<span class="n">pretrained_rxnfp_generator</span> <span class="o">=</span> <span class="n">RXNBERTFingerprintGenerator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">fps_pretrained</span> <span class="o">=</span> <span class="n">generate_fingerprints</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rxn</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">pretrained_rxnfp_generator</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="s1">&#39;../data/fps_pretrained&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps_pretrained</span><span class="p">)</span>
<span class="n">fps_pretrained</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 6250/6250 [02:53&lt;00:00, 35.93it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(50000, 256)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ft-model">ft model<a class="anchor-link" href="#ft-model"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_default_model_and_tokenizer</span><span class="p">(</span><span class="s1">&#39;bert_ft&#39;</span><span class="p">)</span>
<span class="n">ft_rxnfp_generator</span> <span class="o">=</span> <span class="n">RXNBERTFingerprintGenerator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">fps_ft</span> <span class="o">=</span> <span class="n">generate_fingerprints</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rxn</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ft_rxnfp_generator</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="s1">&#39;../data/fps_ft&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps_ft</span><span class="p">)</span>
<span class="n">fps_ft</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 6250/6250 [00:56&lt;00:00, 111.34it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(50000, 256)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

